<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALOS - Patrol Detail (No Order)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            /* Dark Mode Design System */
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 142.1 76.2% 36.3%;
            --primary-foreground: 355.7 100% 97.3%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 142.1 76.2% 36.3%;
            --radius: 0.75rem;
            
            /* Status Colors - Dark Mode Optimized */
            --success: 142.1 76.2% 36.3%;
            --warning: 38 92% 50%;
            --error: 0 84.2% 60.2%;
            --info: 217.2 91.2% 59.8%;
            
            /* Patrol Point Types */
            --nfc-color: 217.2 91.2% 59.8%;
            --qr-color: 38 92% 50%;
        }
        
        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        /* Dark Mode Button System */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            min-height: 48px; /* Mobile-optimized touch target */
            padding: 0.75rem 1.5rem;
            gap: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        
        .btn-primary {
            background: hsl(var(--success));
            color: hsl(var(--primary-foreground));
            border: 1px solid hsl(var(--success));
        }
        
        .btn-primary:hover {
            background: hsl(var(--success) / 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px hsl(var(--success) / 0.2);
        }
        
        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            border: 1px solid hsl(var(--border));
        }
        
        .btn-secondary:hover {
            background: hsl(var(--accent));
            transform: translateY(-1px);
            box-shadow: 0 4px 8px 0 rgb(0 0 0 / 0.1);
        }

        .btn-scan {
            background: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border: 2px solid hsl(var(--border));
            min-height: 56px;
            font-size: 1.1rem;
            flex-direction: column;
            gap: 0.25rem;
            transition: all 0.3s ease;
        }

        .btn-scan:hover {
            border-color: hsl(var(--primary));
            background: hsl(var(--primary) / 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px hsl(var(--primary) / 0.2);
        }

        .btn-scan.nfc {
            border-color: hsl(var(--nfc-color));
        }

        .btn-scan.nfc:hover {
            border-color: hsl(var(--nfc-color));
            background: hsl(var(--nfc-color) / 0.1);
            box-shadow: 0 8px 16px hsl(var(--nfc-color) / 0.2);
        }

        .btn-scan.qr {
            border-color: hsl(var(--qr-color));
        }

        .btn-scan.qr:hover {
            border-color: hsl(var(--qr-color));
            background: hsl(var(--qr-color) / 0.1);
            box-shadow: 0 8px 16px hsl(var(--qr-color) / 0.2);
        }
        
        /* Simplified Patrol Card System */
        .patrol-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .patrol-card.completed {
            background: hsl(var(--success) / 0.05);
            border-color: hsl(var(--success) / 0.3);
        }

        .patrol-card.completed::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: hsl(var(--success));
            border-radius: var(--radius) 0 0 var(--radius);
        }
        
        .patrol-card.pending {
            background: hsl(var(--muted) / 0.3);
            border-color: hsl(var(--border));
        }
        
        /* Status Badge System */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-completed {
            background: hsl(var(--success) / 0.15);
            color: hsl(var(--success));
        }
        
        .status-pending {
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
        }

        .scan-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid;
        }

        .scan-type-nfc {
            background: hsl(var(--nfc-color) / 0.1);
            color: hsl(var(--nfc-color));
            border-color: hsl(var(--nfc-color) / 0.3);
        }

        .scan-type-qr {
            background: hsl(var(--qr-color) / 0.1);
            color: hsl(var(--qr-color));
            border-color: hsl(var(--qr-color) / 0.3);
        }
        
        /* Progress System */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: hsl(var(--muted));
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: hsl(var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Bottom Action Bar */
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: hsl(var(--background) / 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid hsl(var(--border));
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            z-index: 50;
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .modal-content {
            background: hsl(var(--card));
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: hsl(var(--muted));
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: hsl(var(--primary));
            transform: scale(1.25);
        }

        .step-dot.completed {
            background: hsl(var(--success));
        }

        /* Photo Grid System */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .photo-item {
            aspect-ratio: 1;
            border-radius: calc(var(--radius) - 4px);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid hsl(var(--border));
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            border: 2px dashed hsl(var(--border));
            border-radius: calc(var(--radius) - 4px);
            cursor: pointer;
            transition: all 0.3s ease;
            background: hsl(var(--muted) / 0.3);
        }
        
        .photo-upload-btn:hover {
            background: hsl(var(--accent));
            border-color: hsl(var(--primary));
            transform: scale(1.05);
        }

        /* Checklist System */
        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) - 4px);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checklist-item:hover {
            background: hsl(var(--muted) / 0.5);
        }
        
        .checklist-item.completed {
            background: hsl(var(--success) / 0.1);
            border-color: hsl(var(--success) / 0.3);
        }
        
        .checklist-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid hsl(var(--border));
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            flex-shrink: 0;
        }
        
        .checklist-checkbox.checked {
            background: hsl(var(--success));
            border-color: hsl(var(--success));
        }
        
        .checklist-checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            color: white;
            font-size: 0.875rem;
            font-weight: bold;
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Pulse animation for scan buttons */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body class="bg-background text-foreground">
    <!-- Header with Navigation -->
    <div class="sticky top-0 z-40 bg-background/95 backdrop-blur-md border-b border-border">
        <div class="px-4 py-3 flex items-center justify-between">
            <button onclick="goBack()" class="p-2 -ml-2 hover:bg-muted rounded-lg transition-colors">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            
            <div class="text-center">
                <h1 class="font-bold text-lg">Patrol Detail</h1>
                <div class="flex items-center justify-center gap-1 text-sm text-muted-foreground">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span>No Order Pattern</span>
                </div>
            </div>
            
            <button onclick="showHelp()" class="p-2 -mr-2 hover:bg-muted rounded-lg transition-colors">
                <i data-lucide="help-circle" class="w-6 h-6"></i>
            </button>
        </div>
        
        <!-- Progress Bar -->
        <div class="px-4 pb-3">
            <div class="flex items-center justify-between text-sm text-muted-foreground mb-2">
                <span>Progress</span>
                <span id="progressText">1 of 5 completed</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress" style="width: 20%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-4 py-4" style="padding-bottom: 120px;">
        
        <!-- Patrol Info Card -->
        <div class="patrol-card mb-6 border-primary/20">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h2 class="text-xl font-bold">PS#00103</h2>
                    <p class="text-muted-foreground">Tes NFC 17 Juni 2025</p>
                </div>
                <div class="text-right text-sm text-muted-foreground">
                    <p>Route: PR#00009</p>
                    <p>Duration: 60 min</p>
                </div>
            </div>
        </div>

        <!-- Pending Points Section -->
        <div class="mb-6">
            <div class="flex items-center gap-2 mb-3">
                <i data-lucide="clock" class="w-5 h-5 text-muted-foreground"></i>
                <h3 class="font-semibold text-lg">Remaining</h3>
                <span class="text-sm text-muted-foreground" id="pendingCount">(4)</span>
            </div>
            
            <!-- Point 2: Lobby (QR + Checklist) -->
            <div class="patrol-card pending" id="point2">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-muted-foreground/20 rounded-full flex items-center justify-center text-muted-foreground font-bold text-sm">
                            2
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">Lobby</h4>
                            <p class="text-muted-foreground text-sm mb-2">LOC#00002</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-pending">
                                    <div class="w-2 h-2 bg-muted-foreground rounded-full"></div>
                                    Pending
                                </div>
                                <div class="scan-type-badge scan-type-qr">
                                    <i data-lucide="qr-code" class="w-3 h-3"></i>
                                    QR
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    Has checklist (2 items)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Point 3: Staff Room (NFC) -->
            <div class="patrol-card pending" id="point3">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-muted-foreground/20 rounded-full flex items-center justify-center text-muted-foreground font-bold text-sm">
                            3
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">Staff Room</h4>
                            <p class="text-muted-foreground text-sm mb-2">LOC#00003</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-pending">
                                    <div class="w-2 h-2 bg-muted-foreground rounded-full"></div>
                                    Pending
                                </div>
                                <div class="scan-type-badge scan-type-nfc">
                                    <i data-lucide="smartphone" class="w-3 h-3"></i>
                                    NFC
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    No checklist
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Point 4: Meeting Room (QR + Checklist) -->
            <div class="patrol-card pending" id="point4">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-muted-foreground/20 rounded-full flex items-center justify-center text-muted-foreground font-bold text-sm">
                            4
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">Meeting Room</h4>
                            <p class="text-muted-foreground text-sm mb-2">LOC#00004</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-pending">
                                    <div class="w-2 h-2 bg-muted-foreground rounded-full"></div>
                                    Pending
                                </div>
                                <div class="scan-type-badge scan-type-qr">
                                    <i data-lucide="qr-code" class="w-3 h-3"></i>
                                    QR
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    Has checklist (4 items)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Point 5: Security Office (NFC) -->
            <div class="patrol-card pending" id="point5">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-muted-foreground/20 rounded-full flex items-center justify-center text-muted-foreground font-bold text-sm">
                            5
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">Security Office</h4>
                            <p class="text-muted-foreground text-sm mb-2">LOC#00005</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-pending">
                                    <div class="w-2 h-2 bg-muted-foreground rounded-full"></div>
                                    Pending
                                </div>
                                <div class="scan-type-badge scan-type-nfc">
                                    <i data-lucide="smartphone" class="w-3 h-3"></i>
                                    NFC
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    No checklist
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Points Section -->
        <div class="mb-6" id="completedSection">
            <div class="flex items-center gap-2 mb-3">
                <i data-lucide="check-circle" class="w-5 h-5 text-success"></i>
                <h3 class="font-semibold text-lg">Completed Points</h3>
                <span class="text-sm text-muted-foreground" id="completedCount">(1)</span>
            </div>
            
            <!-- Completed Point 1 -->
            <div class="patrol-card completed fade-in" id="point1">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-success rounded-full flex items-center justify-center text-white font-bold text-sm">
                            <i data-lucide="check" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">Parkiran Depan</h4>
                            <p class="text-muted-foreground text-sm mb-2">LOC#00008</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-completed">
                                    <div class="w-2 h-2 bg-success rounded-full"></div>
                                    Completed
                                </div>
                                <div class="scan-type-badge scan-type-nfc">
                                    <i data-lucide="smartphone" class="w-3 h-3"></i>
                                    NFC
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    âœ“ 4 photos â€¢ âœ“ Notes â€¢ âœ“ Checklist
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="viewDetails('LOC#00008')" class="p-1 hover:bg-muted rounded" title="View Details">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Action Bar -->
    <div class="bottom-action-bar" role="toolbar" aria-label="Scan patrol points">
        <button class="btn-scan nfc pulse" onclick="scanNFC()" aria-label="Scan NFC patrol point" aria-describedby="nfc-help">
            <i data-lucide="smartphone" class="w-8 h-8" aria-hidden="true"></i>
            <span class="text-sm font-medium">Scan NFC</span>
        </button>
        <button class="btn-scan qr pulse" onclick="scanQR()" aria-label="Scan QR code patrol point" aria-describedby="qr-help">
            <i data-lucide="qr-code" class="w-8 h-8" aria-hidden="true"></i>
            <span class="text-sm font-medium">Scan QR</span>
        </button>
        <div id="nfc-help" class="sr-only">Hold your phone near an NFC tag to scan</div>
        <div id="qr-help" class="sr-only">Point your camera at a QR code to scan</div>
    </div>

    <!-- Post-Scan Modal Workflow -->
    <div class="modal-overlay" id="postScanModal">
        <div class="modal-content slide-up">
            <!-- Step Indicator -->
            <div class="modal-step-indicator">
                <div class="step-dot" id="step1"></div>
                <div class="step-dot" id="step2"></div>
                <div class="step-dot" id="step3"></div>
            </div>
            
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold" id="modalTitle">Complete Patrol Point</h3>
                <button onclick="closePostScanModal()" class="p-1 hover:bg-muted rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Step Content -->
            <div id="modalContent">
                <!-- Dynamic content will be loaded here -->
            </div>
            
            <!-- Modal Actions -->
            <div class="flex gap-3 mt-6" id="modalActions">
                <!-- Dynamic actions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div class="modal-overlay" id="photoViewerModal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">Photo Details</h3>
                <button onclick="closeModal('photoViewerModal')" class="p-1 hover:bg-muted rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="photoViewerContent" class="text-center">
                <!-- Photo content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // Global state management
        let completedPoints = 1;
        let totalPoints = 5;
        let currentModalStep = 1;
        let currentLocationId = null;
        let scannedLocationData = null;
        
        // Sample data for completed point
        const pointPhotos = {
            'LOC#00008': [
                {
                    id: 1,
                    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=400&fit=crop&crop=center',
                    timestamp: '2024-06-17T09:15:00Z',
                    alt: 'Parking gate view'
                },
                {
                    id: 2,
                    url: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=400&fit=crop&crop=center',
                    timestamp: '2024-06-17T09:15:00Z',
                    alt: 'Parking area lights'
                },
                {
                    id: 3,
                    url: 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=400&h=400&fit=crop&crop=center',
                    timestamp: '2024-06-17T09:15:00Z',
                    alt: 'Security camera'
                },
                {
                    id: 4,
                    url: 'https://images.unsplash.com/photo-1534644107580-3a4dbd494a95?w=400&h=400&fit=crop&crop=center',
                    timestamp: '2024-06-17T09:15:00Z',
                    alt: 'NFC tag location'
                }
            ]
        };

        const pointNotes = {
            'LOC#00008': 'All parking sensors working properly. Gate mechanism smooth. No security issues detected.'
        };

        const checklistData = {
            'LOC#00002': [
                { id: 1, text: 'Check reception desk area', completed: false, required: true },
                { id: 2, text: 'Verify visitor log book', completed: false, required: true }
            ],
            'LOC#00004': [
                { id: 1, text: 'Check projector functionality', completed: false, required: true },
                { id: 2, text: 'Ensure windows are secure', completed: false, required: true },
                { id: 3, text: 'Verify air conditioning settings', completed: false, required: false },
                { id: 4, text: 'Check emergency exits', completed: false, required: true }
            ],
            'LOC#00008': [
                { id: 1, text: 'Check parking gate operation', completed: true, required: true },
                { id: 2, text: 'Verify lighting system', completed: true, required: true }
            ]
        };

        // Point information database
        const pointInfo = {
            'LOC#00002': { name: 'Lobby', type: 'QR', hasChecklist: true },
            'LOC#00003': { name: 'Staff Room', type: 'NFC', hasChecklist: false },
            'LOC#00004': { name: 'Meeting Room', type: 'QR', hasChecklist: true },
            'LOC#00005': { name: 'Security Office', type: 'NFC', hasChecklist: false },
            'LOC#00008': { name: 'Parkiran Depan', type: 'NFC', hasChecklist: true }
        };
        
        // Initialize
        function init() {
            updateProgress();
        }
        
        // Update progress display
        function updateProgress() {
            const progressPercent = (completedPoints / totalPoints) * 100;
            document.getElementById('overallProgress').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = `${completedPoints} of ${totalPoints} completed`;
            document.getElementById('completedCount').textContent = `(${completedPoints})`;
            document.getElementById('pendingCount').textContent = `(${totalPoints - completedPoints})`;
        }

        // Navigation functions
        function goBack() {
            if (confirm('Return to patrol schedule? Your progress will be saved.')) {
                window.history.back();
            }
        }

        function showHelp() {
            alert('ðŸ“± No Order Patrol Guide\n\nâ€¢ Scan any patrol point using bottom buttons\nâ€¢ NFC: Hold phone near NFC tag\nâ€¢ QR: Point camera at QR code\nâ€¢ Complete photos, notes, and checklists after scanning\nâ€¢ Track progress: ' + completedPoints + ' of ' + totalPoints + ' completed');
        }

        function viewDetails(locationId) {
            const photos = pointPhotos[locationId] || [];
            const notes = pointNotes[locationId] || '';
            const checklist = checklistData[locationId] || [];
            
            let details = `ðŸ“ ${pointInfo[locationId].name} (${locationId})\n\n`;
            details += `ðŸ“· Photos: ${photos.length}\n`;
            details += `ðŸ“ Notes: ${notes ? 'Yes' : 'None'}\n`;
            details += `âœ… Checklist: ${checklist.length} items\n\n`;
            
            if (notes) {
                details += `Notes:\n${notes}`;
            }
            
            alert(details);
        }

        // Main scan functions
        function scanNFC() {
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            // Simulate NFC scan detection
            showScanModal('NFC');
        }

        function scanQR() {
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            // Simulate QR scan detection
            showScanModal('QR');
        }

        function showScanModal(scanType) {
            // Simulate detecting a specific location based on scan type
            const nfcLocations = ['LOC#00003', 'LOC#00005'];
            const qrLocations = ['LOC#00002', 'LOC#00004'];
            
            let availableLocations = scanType === 'NFC' ? nfcLocations : qrLocations;
            
            // Filter out already completed locations
            availableLocations = availableLocations.filter(loc => 
                !document.getElementById('point1').innerHTML.includes(loc) // Simple check for demo
            );
            
            if (availableLocations.length === 0) {
                alert(`No ${scanType} patrol points remaining to scan.`);
                return;
            }
            
            // For demo, pick first available location
            const locationId = availableLocations[0];
            
            // Simulate successful scan
            setTimeout(() => {
                detectLocation(locationId, scanType);
            }, 1500);
            
            // Show scanning feedback
            showScanningFeedback(scanType);
        }

        function showScanningFeedback(scanType) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div class="modal-content slide-up text-center">
                    <div class="w-16 h-16 mx-auto mb-4 animate-spin">
                        <i data-lucide="${scanType === 'NFC' ? 'smartphone' : 'qr-code'}" class="w-16 h-16 text-primary"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Scanning ${scanType}...</h3>
                    <p class="text-muted-foreground">Hold steady</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
            lucide.createIcons();
            
            // Remove after detection
            setTimeout(() => {
                overlay.remove();
            }, 1500);
        }

        function detectLocation(locationId, scanType) {
            currentLocationId = locationId;
            scannedLocationData = pointInfo[locationId];
            
            // Show success and start post-scan workflow
            showScanSuccess(locationId, scanType);
        }

        function showScanSuccess(locationId, scanType) {
            const locationName = pointInfo[locationId].name;
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div class="modal-content slide-up text-center">
                    <div class="w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Scan Successful!</h3>
                    <p class="text-muted-foreground mb-4">${locationName} (${locationId})</p>
                    <button class="btn btn-primary" onclick="startPostScanWorkflow('${locationId}')">
                        Continue
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            lucide.createIcons();
            
            // Auto-continue after 2 seconds
            setTimeout(() => {
                overlay.remove();
                startPostScanWorkflow(locationId);
            }, 2000);
        }

        function startPostScanWorkflow(locationId) {
            currentLocationId = locationId;
            currentModalStep = 1;
            
            // Initialize modal workflow
            showPostScanModal(locationId);
        }

        function showPostScanModal(locationId) {
            const modal = document.getElementById('postScanModal');
            const locationName = pointInfo[locationId].name;
            
            // Update modal title
            document.getElementById('modalTitle').textContent = `Complete: ${locationName}`;
            
            // Start with step 1 (Photos)
            loadModalStep(1);
            
            // Show modal
            modal.style.display = 'flex';
        }

        function loadModalStep(step) {
            currentModalStep = step;
            updateStepIndicator();
            
            const content = document.getElementById('modalContent');
            const actions = document.getElementById('modalActions');
            
            switch(step) {
                case 1:
                    loadPhotoStep(content, actions);
                    break;
                case 2:
                    loadNotesStep(content, actions);
                    break;
                case 3:
                    loadChecklistStep(content, actions);
                    break;
            }
            
            // Refresh icons
            lucide.createIcons();
        }

        function loadPhotoStep(content, actions) {
            if (!pointPhotos[currentLocationId]) {
                pointPhotos[currentLocationId] = [];
            }

            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-medium mb-2">Add Photos (Optional)</h4>
                    <p class="text-sm text-muted-foreground mb-4">Capture up to 4 photos of the patrol point</p>
                    <div class="photo-grid" id="modalPhotoGrid">
                        ${generatePhotoGridHTML(currentLocationId)}
                    </div>
                    <input type="file" id="modalPhotoInput" accept="image/*" capture="camera" style="display: none;" onchange="handleModalPhotoUpload(event)">
                </div>
            `;
            
            actions.innerHTML = `
                <button class="btn btn-secondary flex-1" onclick="skipStep()">
                    Skip Photos
                </button>
                <button class="btn btn-primary flex-1" onclick="nextModalStep()">
                    Next <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            `;
        }

        function loadNotesStep(content, actions) {
            const existingNote = pointNotes[currentLocationId] || '';
            
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-medium mb-2">Add Notes (Optional)</h4>
                    <p class="text-sm text-muted-foreground mb-4">Record observations or incidents</p>
                    <textarea 
                        id="modalNotesInput" 
                        class="w-full h-32 p-3 border border-border rounded-md bg-background text-foreground resize-none"
                        placeholder="Enter notes about this patrol point..."
                        style="background: hsl(var(--background)); color: hsl(var(--foreground)); border-color: hsl(var(--border));"
                    >${existingNote}</textarea>
                </div>
            `;
            
            actions.innerHTML = `
                <button class="btn btn-secondary flex-1" onclick="prevModalStep()">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                </button>
                <button class="btn btn-secondary flex-1" onclick="skipStep()">
                    Skip Notes
                </button>
                <button class="btn btn-primary flex-1" onclick="nextModalStep()">
                    Next <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            `;
        }

        function loadChecklistStep(content, actions) {
            const hasChecklist = checklistData[currentLocationId] && checklistData[currentLocationId].length > 0;
            
            if (!hasChecklist) {
                // Skip to completion if no checklist
                completePatrolPoint();
                return;
            }
            
            const checklist = checklistData[currentLocationId];
            
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-medium mb-2">Complete Checklist</h4>
                    <p class="text-sm text-muted-foreground mb-4">Mark all required items</p>
                    <div id="modalChecklistItems" class="space-y-2">
                        ${generateChecklistHTML(checklist)}
                    </div>
                </div>
            `;
            
            const requiredItems = checklist.filter(item => item.required);
            const completedRequired = requiredItems.filter(item => item.completed);
            const canComplete = completedRequired.length === requiredItems.length;
            
            actions.innerHTML = `
                <button class="btn btn-secondary flex-1" onclick="prevModalStep()">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back
                </button>
                <button class="btn btn-primary flex-1 ${!canComplete ? 'opacity-50 cursor-not-allowed' : ''}" 
                        onclick="completePatrolPoint()" ${!canComplete ? 'disabled' : ''}>
                    <i data-lucide="check" class="w-4 h-4"></i> Complete
                </button>
            `;
        }

        function generatePhotoGridHTML(locationId) {
            const photos = pointPhotos[locationId] || [];
            let html = '';
            
            // Add existing photos
            photos.forEach(photo => {
                html += `
                    <div class="photo-item" onclick="viewModalPhoto('${photo.url}')">
                        <img src="${photo.url}" alt="${photo.alt || 'Patrol photo'}">
                    </div>
                `;
            });
            
            // Add upload button if less than 4 photos
            if (photos.length < 4) {
                html += `
                    <div class="photo-upload-btn" onclick="captureModalPhoto()">
                        <i data-lucide="camera" class="w-6 h-6"></i>
                    </div>
                `;
            }
            
            return html;
        }

        function generateChecklistHTML(checklist) {
            return checklist.map((item, index) => `
                <div class="checklist-item ${item.completed ? 'completed' : ''}" onclick="toggleModalChecklistItem(${index})">
                    <div class="checklist-checkbox ${item.completed ? 'checked' : ''}"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${item.text}</p>
                        ${item.required ? '<span class="text-xs text-red-400">Required</span>' : '<span class="text-xs text-muted-foreground">Optional</span>'}
                    </div>
                </div>
            `).join('');
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`step${i}`);
                dot.classList.remove('active', 'completed');
                
                if (i < currentModalStep) {
                    dot.classList.add('completed');
                } else if (i === currentModalStep) {
                    dot.classList.add('active');
                }
            }
        }

        function nextModalStep() {
            // Save current step data
            saveCurrentStepData();
            
            if (currentModalStep < 3) {
                loadModalStep(currentModalStep + 1);
            }
        }

        function prevModalStep() {
            if (currentModalStep > 1) {
                loadModalStep(currentModalStep - 1);
            }
        }

        function skipStep() {
            nextModalStep();
        }

        function saveCurrentStepData() {
            switch(currentModalStep) {
                case 2: // Notes step
                    const notesInput = document.getElementById('modalNotesInput');
                    if (notesInput && notesInput.value.trim()) {
                        pointNotes[currentLocationId] = notesInput.value.trim();
                    }
                    break;
            }
        }

        function captureModalPhoto() {
            document.getElementById('modalPhotoInput').click();
        }

        function handleModalPhotoUpload(event) {
            const file = event.target.files[0];
            if (file && currentLocationId) {
                // Initialize photos array if not exists
                if (!pointPhotos[currentLocationId]) {
                    pointPhotos[currentLocationId] = [];
                }
                
                // Check if we can add more photos
                if (pointPhotos[currentLocationId].length >= 4) {
                    alert('Maximum 4 photos allowed per patrol point');
                    return;
                }
                
                // Add photo to storage (using URL.createObjectURL for demo)
                pointPhotos[currentLocationId].push({
                    id: Date.now(),
                    url: URL.createObjectURL(file),
                    timestamp: new Date().toISOString(),
                    alt: 'Patrol photo'
                });
                
                // Refresh photo grid
                const grid = document.getElementById('modalPhotoGrid');
                grid.innerHTML = generatePhotoGridHTML(currentLocationId);
                lucide.createIcons();
            }
            
            // Clear input
            event.target.value = '';
        }

        function viewModalPhoto(url) {
            const modal = document.getElementById('photoViewerModal');
            const content = document.getElementById('photoViewerContent');
            
            content.innerHTML = `<img src="${url}" style="max-width: 100%; height: auto; border-radius: var(--radius);">`;
            modal.style.display = 'flex';
        }

        function toggleModalChecklistItem(index) {
            if (!currentLocationId || !checklistData[currentLocationId]) return;
            
            const item = checklistData[currentLocationId][index];
            item.completed = !item.completed;
            
            // Refresh checklist display
            const container = document.getElementById('modalChecklistItems');
            container.innerHTML = generateChecklistHTML(checklistData[currentLocationId]);
            
            // Update complete button state
            const checklist = checklistData[currentLocationId];
            const requiredItems = checklist.filter(item => item.required);
            const completedRequired = requiredItems.filter(item => item.completed);
            const canComplete = completedRequired.length === requiredItems.length;
            
            const completeBtn = document.querySelector('.btn-primary[onclick="completePatrolPoint()"]');
            if (completeBtn) {
                if (canComplete) {
                    completeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    completeBtn.disabled = false;
                } else {
                    completeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    completeBtn.disabled = true;
                }
            }
            
            lucide.createIcons();
        }

        function completePatrolPoint() {
            // Save final notes
            saveCurrentStepData();
            
            // Close modal
            closePostScanModal();
            
            // Update UI to reflect completion
            movePointToCompleted(currentLocationId);
            
            // Show completion feedback
            showCompletionFeedback();
            
            // Reset state
            currentLocationId = null;
            currentModalStep = 1;
        }

        function movePointToCompleted(locationId) {
            // Find the point card
            const pointCards = document.querySelectorAll('.patrol-card');
            let targetCard = null;
            
            pointCards.forEach(card => {
                if (card.innerHTML.includes(locationId)) {
                    targetCard = card;
                }
            });
            
            if (!targetCard) return;
            
            // Update the card to completed state
            targetCard.classList.remove('pending');
            targetCard.classList.add('completed', 'fade-in');
            
            // Update card content for completed state
            const locationName = pointInfo[locationId].name;
            const scanType = pointInfo[locationId].type;
            const photoCount = pointPhotos[locationId] ? pointPhotos[locationId].length : 0;
            const hasNotes = pointNotes[locationId] ? true : false;
            const hasChecklist = checklistData[locationId] && checklistData[locationId].length > 0;
            
            targetCard.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-success rounded-full flex items-center justify-center text-white font-bold text-sm">
                            <i data-lucide="check" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold mb-1">${locationName}</h4>
                            <p class="text-muted-foreground text-sm mb-2">${locationId}</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="status-badge status-completed">
                                    <div class="w-2 h-2 bg-success rounded-full"></div>
                                    Completed
                                </div>
                                <div class="scan-type-badge scan-type-${scanType.toLowerCase()}">
                                    <i data-lucide="${scanType === 'NFC' ? 'smartphone' : 'qr-code'}" class="w-3 h-3"></i>
                                    ${scanType}
                                </div>
                                <div class="text-xs text-muted-foreground">
                                    ${photoCount > 0 ? `âœ“ ${photoCount} photos` : ''}
                                    ${hasNotes ? ' â€¢ âœ“ Notes' : ''}
                                    ${hasChecklist ? ' â€¢ âœ“ Checklist' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onclick="viewDetails('${locationId}')" class="p-1 hover:bg-muted rounded" title="View Details">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            // Move card to completed section
            const completedSection = document.getElementById('completedSection');
            completedSection.appendChild(targetCard);
            
            // Update progress
            completedPoints++;
            updateProgress();
            
            // Recreate icons
            lucide.createIcons();
        }

        function showCompletionFeedback() {
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
            const locationName = pointInfo[currentLocationId].name;
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <div class="modal-content slide-up text-center">
                    <div class="w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Point Completed!</h3>
                    <p class="text-muted-foreground mb-4">${locationName} successfully documented</p>
                    <p class="text-sm text-muted-foreground">Progress: ${completedPoints}/${totalPoints} completed</p>
                </div>
            `;
            
            document.body.appendChild(overlay);
            lucide.createIcons();
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                overlay.remove();
            }, 3000);
        }

        function closePostScanModal() {
            const modal = document.getElementById('postScanModal');
            modal.style.display = 'none';
            currentModalStep = 1;
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        // Accessibility and mobile enhancements
        function handleKeyboard(event) {
            // Handle keyboard navigation for modals
            if (event.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal-overlay[style*="flex"]');
                if (openModals.length > 0) {
                    openModals[openModals.length - 1].style.display = 'none';
                }
            }
        }

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
                if (e.target.id === 'postScanModal') {
                    currentModalStep = 1;
                    currentLocationId = null;
                }
            }
        });

        // Add keyboard support
        document.addEventListener('keydown', handleKeyboard);

        // Prevent double-tap zoom on scan buttons
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>